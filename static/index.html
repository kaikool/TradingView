<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TradingView Chart Capture API</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    .card{backdrop-filter:blur(10px);background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:15px;box-shadow:0 8px 32px 0 rgba(31,38,135,.37)}
    .btn-primary{background:linear-gradient(45deg,#667eea,#764ba2);border:none;border-radius:10px;transition:transform .2s}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.3)}
    .form-control,.form-select{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:10px}
    .form-control:focus,.form-select:focus{background:rgba(255,255,255,.15);border-color:#667eea;box-shadow:0 0 0 .2rem rgba(102,126,234,.25);color:#fff}
    .form-control::placeholder{color:rgba(255,255,255,.7)}
    .text-white{color:#fff!important}
    .status-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px}
    .status-online{background:#28a745;box-shadow:0 0 10px #28a745}
    .status-offline{background:#dc3545;box-shadow:0 0 10px #dc3545}
    .loading-spinner{display:none}
    .result-card{display:none;margin-top:20px}
    .hardcoded-info{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:10px;padding:15px;margin-bottom:20px}
    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;font-size:.85rem}
  </style>
</head>
<body>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="text-center mb-5">
        <h1 class="text-white mb-3"><i class="fas fa-chart-line me-3"></i>TradingView Chart Capture API</h1>
        <p class="text-white opacity-75">Automated chart screenshot capture service v2.0.0</p>
        <div class="d-flex justify-content-center align-items-center">
          <span class="status-indicator" id="statusIndicator"></span>
          <span class="text-white" id="statusText">Checking status...</span>
        </div>
      </div>

      <div class="hardcoded-info">
        <h6 class="text-white mb-3"><i class="fas fa-cog me-2"></i>Hardcoded Configuration (Optimized)</h6>
        <div class="info-grid text-white">
          <div><strong>Chart ID:</strong> fCLTltqk</div>
          <div><strong>Window Size:</strong> 1920x1080</div>
          <div><strong>Browser Mode:</strong> Headless (Cloud Run)</div>
          <div><strong>Chart Adjustment:</strong> 30 RIGHT keys</div>
          <div><strong>Load Wait:</strong> 5 seconds</div>
          <div><strong>Flow:</strong> Alt+S â†’ read URL (DOM)</div>
        </div>
      </div>

      <div class="card">
        <div class="card-body p-4">
          <h5 class="text-white mb-4"><i class="fas fa-camera me-2"></i>Capture Chart Screenshot Link</h5>
          <form id="captureForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="ticker" class="form-label text-white"><i class="fas fa-coins me-1"></i>Symbol/Ticker</label>
                <input type="text" class="form-control" id="ticker" name="ticker" placeholder="e.g., OANDA:XAUUSD, BINANCE:BTCUSDT"/>
                <div class="form-text text-white opacity-75">Optional: override chart symbol</div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="timeframe" class="form-label text-white"><i class="fas fa-clock me-1"></i>Timeframe</label>
                <select class="form-select" id="timeframe" name="timeframe">
                  <option value="1M">1 minute</option>
                  <option value="3M">3 minutes</option>
                  <option value="5M">5 minutes</option>
                  <option value="15M" selected>15 minutes</option>
                  <option value="30M">30 minutes</option>
                  <option value="H1">1 hour</option>
                  <option value="H2">2 hours</option>
                  <option value="H4">4 hours</option>
                  <option value="H6">6 hours</option>
                  <option value="H12">12 hours</option>
                  <option value="D">1 day</option>
                  <option value="W">1 week</option>
                  <option value="M">1 month</option>
                </select>
                <div class="form-text text-white opacity-75">Maps to interval= on TradingView</div>
              </div>
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-primary btn-lg px-5">
                <i class="fas fa-camera me-2"></i><span class="button-text">Capture Screenshot</span>
              </button>
              <div class="loading-spinner mt-3">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                <div class="text-white mt-2">Processing capture request...</div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card result-card" id="resultCard">
        <div class="card-body p-4">
          <div id="successResult" class="d-none">
            <h5 class="text-white mb-3"><i class="fas fa-check-circle text-success me-2"></i>Captured!</h5>
            <div class="mb-3">
              <label class="form-label text-white">Screenshot URL:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="screenshotUrl" readonly/>
                <button class="btn btn-outline-light" type="button" onclick="copyToClipboard()"><i class="fas fa-copy"></i></button>
              </div>
            </div>
            <div class="text-center">
              <a id="screenshotLink" href="#" target="_blank" class="btn btn-success me-2"><i class="fas fa-external-link-alt me-2"></i>Open</a>
              <button class="btn btn-outline-light" onclick="downloadImage()"><i class="fas fa-download me-2"></i>Download</button>
            </div>
          </div>
          <div id="errorResult" class="d-none">
            <h5 class="text-white mb-3"><i class="fas fa-exclamation-circle text-danger me-2"></i>Capture Failed</h5>
            <div class="alert alert-danger"><span id="errorMessage"></span></div>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-body p-4">
          <h6 class="text-white mb-3"><i class="fas fa-code me-2"></i>API Examples</h6>
          <div class="text-white opacity-75 small">
            <p><strong>Default capture (15M timeframe):</strong></p>
            <code class="text-warning" id="example1">curl -X POST "YOUR_API_URL/capture" -H "Content-Type: application/json" -d '{"timeframe":"15M"}'</code>
            <p class="mt-3"><strong>BTCUSDT H4 chart:</strong></p>
            <code class="text-warning" id="example2">curl -X POST "YOUR_API_URL/capture" -H "Content-Type: application/json" -d '{"timeframe":"H4","ticker":"BINANCE:BTCUSDT"}'</code>
          </div>
        </div>
      </div>

      <div class="text-center mt-4">
        <a href="/docs" class="text-white text-decoration-none opacity-75"><i class="fas fa-book me-1"></i>View API Docs</a>
      </div>
    </div>
  </div>
</div>

<script>
async function checkHealth(){
  try{
    const res = await fetch('/health');
    const data = await res.json();
    if (data.ok && data.selenium_ready){
      document.getElementById('statusIndicator').className = 'status-indicator status-online';
      document.getElementById('statusText').textContent = 'Online & Selenium Ready';
    }else{
      document.getElementById('statusIndicator').className = 'status-indicator status-offline';
      document.getElementById('statusText').textContent = 'Online (Selenium Issue)';
    }
  }catch(e){
    document.getElementById('statusIndicator').className = 'status-indicator status-offline';
    document.getElementById('statusText').textContent = 'Service Offline';
  }
}

document.getElementById('captureForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const formData = new FormData(e.target);
  const payload = {
    ticker: formData.get('ticker') || "NONE",
    timeframe: formData.get('timeframe') || "D"
  };

  document.querySelector('.loading-spinner').style.display = 'block';
  document.querySelector('.button-text').textContent = 'Processing...';
  document.querySelector('button[type="submit"]').disabled = true;
  document.getElementById('resultCard').style.display = 'none';

  try{
    const resp = await fetch('/capture', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const result = await resp.json();
    if (!resp.ok) throw new Error(result.detail || 'Unknown error');

    document.getElementById('screenshotUrl').value = result.screenshot_url;
    document.getElementById('screenshotLink').href = result.screenshot_url;

    document.getElementById('successResult').className = 'd-block';
    document.getElementById('errorResult').className = 'd-none';
  }catch(err){
    document.getElementById('errorMessage').textContent = err.message;
    document.getElementById('errorResult').className = 'd-block';
    document.getElementById('successResult').className = 'd-none';
  }finally{
    document.querySelector('.loading-spinner').style.display = 'none';
    document.querySelector('.button-text').textContent = 'Capture Screenshot';
    document.querySelector('button[type="submit"]').disabled = false;
    document.getElementById('resultCard').style.display = 'block';
  }
});

function copyToClipboard(){
  const urlInput = document.getElementById('screenshotUrl');
  urlInput.select();
  document.execCommand('copy');
  const copyBtn = event.target.closest('button');
  const originalHTML = copyBtn.innerHTML;
  copyBtn.innerHTML = '<i class="fas fa-check"></i>';
  setTimeout(()=>{copyBtn.innerHTML = originalHTML;},1000);
}

function downloadImage(){
  const imageUrl = document.getElementById('screenshotUrl').value;
  if(imageUrl){
    const a = document.createElement('a');
    a.href = imageUrl;
    a.download = 'tradingview-chart-' + Date.now() + '.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
}

function updateApiExamples(){
  const base = location.origin;
  document.getElementById('example1').textContent =
    `curl -X POST "${base}/capture" -H "Content-Type: application/json" -d '{"timeframe":"15M"}'`;
  document.getElementById('example2').textContent =
    `curl -X POST "${base}/capture" -H "Content-Type: application/json" -d '{"timeframe":"H4","ticker":"BINANCE:BTCUSDT"}'`;
}

checkHealth();
updateApiExamples();
setInterval(checkHealth, 30000);
</script>
</body>
</html>
